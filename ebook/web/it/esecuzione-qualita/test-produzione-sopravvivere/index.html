<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Test di Produzione ‚Äì Sopravvivere nel Mondo Reale | Esecuzione Qualita | AI Team Orchestrator</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Capitolo 19 del libro AI Team Orchestrator: Il Test di Produzione ‚Äì Sopravvivere nel Mondo Reale">
    <meta name="keywords" content="AI agents, sistema AI-driven, architettura AI, OpenAI SDK, team AI">
    <meta name="author" content="Daniele Pelleri">
    <meta name="robots" content="index, follow">

    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Il Test di Produzione ‚Äì Sopravvivere nel Mondo Reale">
    <meta property="og:description" content="Capitolo 19 del libro AI Team Orchestrator: Il Test di Produzione ‚Äì Sopravvivere nel Mondo Reale">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://books.danielepelleri.com/it/esecuzione-qualita/test-produzione-sopravvivere/">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://books.danielepelleri.com/it/esecuzione-qualita/test-produzione-sopravvivere/">
    <link rel="alternate" hreflang="en" href="https://books.danielepelleri.com/en/execution-quality/test-produzione-sopravvivere/">
    <link rel="alternate" hreflang="it" href="https://books.danielepelleri.com/it/esecuzione-qualita/test-produzione-sopravvivere/">
    
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Breadcrumb Navigation */
        .breadcrumb {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }
        
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb span {
            color: #7f8c8d;
            margin: 0 0.5rem;
        }
        
        /* Chapter Header */
        .chapter-header {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 3rem;
            text-align: center;
        }
        
        .chapter-instrument {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .chapter-meta {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            flex-wrap: wrap;
        }
        
        .chapter-title {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        /* Content Styles */
        .chapter-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin-bottom: 3rem;
        }
        
        .chapter-content h3 {
            font-size: 2rem;
            color: #2c3e50;
            margin: 2rem 0 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        
        .chapter-content h4 {
            font-size: 1.5rem;
            color: #495057;
            margin: 1.5rem 0 1rem;
        }
        
        .chapter-content p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .chapter-content ul, .chapter-content ol {
            margin: 1.5rem 0;
            padding-left: 2rem;
        }
        
        .chapter-content li {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 2rem 0;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        /* Code Styles */
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }
        
        code {
            background: #f1f3f4;
            color: #d73a49;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        pre code {
            background: transparent;
            color: inherit;
            padding: 0;
        }
        
        /* Special Boxes */
        .war-story, .industry-insight, .architecture-section, .key-takeaways-section {
            border-radius: 10px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .war-story {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 4px solid #856404;
        }
        
        .industry-insight {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 4px solid #28a745;
        }
        
        .architecture-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
        }
        
        .key-takeaways-section {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        
        /* Mermaid Container */
        .mermaid {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            text-align: center;
        }
        
        /* Navigation */
        .chapter-nav-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 3rem 0;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .nav-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .nav-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        .nav-button.secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: 2px solid #667eea;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .nav-button.secondary:hover {
            background: white;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        /* War Story Icon Styling */
        .war-story-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .war-story-icon {
            width: 1.5rem;
            height: 1.5rem;
            flex-shrink: 0;
            color: #856404;
        }
        
        /* Architecture Section Styling */
        .architecture-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .architecture-icon {
            width: 2rem;
            height: 2rem;
            flex-shrink: 0;
            color: #667eea;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .chapter-header,
            .chapter-content {
                padding: 2rem;
            }
            
            .chapter-title {
                font-size: 2rem;
            }
            
            .chapter-nav-bottom {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
        
        /* Reader Tools */
        .reader-tools {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tool-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tool-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        /* Bookmark Modal */
        .bookmarks-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .bookmark-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .bookmark-item:last-child {
            border-bottom: none;
        }
        
        .bookmark-link {
            color: #667eea;
            text-decoration: none;
        }
        
        .bookmark-link:hover {
            text-decoration: underline;
        }
        
        /* Reading Progress Bar */
        .reading-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(102, 126, 234, 0.2);
            z-index: 999;
        }
        
        .reading-progress::before {
            content: '';
            display: block;
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform-origin: left;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        /* Dark Mode */
        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
        }
        
        body.dark-mode .chapter-header,
        body.dark-mode .chapter-content,
        body.dark-mode .breadcrumb {
            background: rgba(52, 73, 94, 0.8);
            color: #ecf0f1;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 10001;
        }
        
        .toast.show {
            transform: translateX(0);
        }
</head>
<body>
    <!-- Reading Progress Bar -->
    <div class="reading-progress" id="readingProgress"></div>
    
    <!-- Reader Tools -->
    <div class="reader-tools">
        <button class="tool-button" onclick="addBookmark()" title="I Miei Segnalibri">üìö</button>
        <button class="tool-button" onclick="toggleTheme()" title="Tema">üé®</button>
        <button class="tool-button" onclick="increaseFontSize()" title="Dimensione Font +">A+</button>
        <button class="tool-button" onclick="decreaseFontSize()" title="Dimensione Font -">A-</button>
    </div>
    
    <!-- Bookmark Modal -->
    <div id="bookmarksModal" class="bookmarks-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeBookmarksModal()">&times;</span>
            <h3>üìö I Miei Segnalibri</h3>
            <div id="bookmarksList">
                <!-- Bookmarks will be populated by JavaScript -->
            </div>
        </div>
    </div>    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="../../ai-team-orchestrator.html">üè† AI Team Orchestrator</a>
            <span>‚Ä∫</span>
            <a href="../">üé∫ Esecuzione Qualita</a>
            <span>‚Ä∫</span>
            <span>Il Test di Produzione ‚Äì Sopravvivere nel Mondo Reale</span>
        </nav>

        <!-- Chapter Header -->
        <header class="chapter-header">
            <div class="chapter-instrument">üé∫</div>
            <div class="chapter-meta">
                <span>üé∫ Movimento 2 di 4</span>
                <span>üìñ Capitolo 19 di 42</span>
                <span>‚è±Ô∏è ~5 min lettura</span>
                <span>üìä Livello: Intermedio</span>
            </div>
            <h1 class="chapter-title">Il Test di Produzione ‚Äì Sopravvivere nel Mondo Reale</h1>
        </header>

        <!-- Main Content -->
        <article class="chapter-content">
<p>Il nostro sistema aveva superato l'esame di maturit√†. Il test comprensivo ci aveva dato la fiducia che l'architettura fosse solida e che il flusso end-to-end funzionasse come previsto. Ma c'era un'ultima, fondamentale differenza tra il nostro ambiente di test e il mondo reale: <strong>nel nostro ambiente di test, l'AI era un simulatore.</strong></p>

<p>Avevamo "mockato" le chiamate all'SDK di OpenAI per rendere i test veloci, economici e deterministici. Era stata la scelta giusta per lo sviluppo, ma ora dovevamo rispondere alla domanda finale: il nostro sistema √® in grado di gestire la vera, imprevedibile e a volte caotica intelligenza di un modello LLM di produzione come GPT-4?</p>

<p>Era il momento del <strong>Test di Produzione</strong>.</p>

<h3>La Decisione Architetturale: Un Ambiente di "Pre-Produzione"</h3>

<p>Non potevamo eseguire questo test direttamente sull'ambiente di produzione dei nostri futuri clienti. Dovevamo creare un terzo ambiente, un clone esatto della produzione, ma isolato: l'ambiente di <strong>Pre-Produzione (Pre-Prod)</strong>.</p>

<table>
<thead>
<tr>
<th>Ambiente</th>
<th>Scopo</th>
<th>Configurazione AI</th>
<th>Costo</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Sviluppo Locale</strong></td>
<td>Sviluppo e test di unit√†</td>
<td>Mock AI Provider</td>
<td>Zero</td>
</tr>
<tr>
<td><strong>Staging (CI/CD)</strong></td>
<td>Test di integrazione e comprensivi</td>
<td>Mock AI Provider</td>
<td>Zero</td>
</tr>
<tr>
<td><strong>Pre-Produzione</strong></td>
<td>Validazione finale con AI reale</td>
<td><strong>OpenAI SDK (GPT-4 Reale)</strong></td>
<td><strong>Alto</strong></td>
</tr>
<tr>
<td><strong>Produzione</strong></td>
<td>Servizio per i clienti</td>
<td>OpenAI SDK (GPT-4 Reale)</td>
<td>Alto</td>
</tr>
</tbody>
</table>

<p>L'ambiente di Pre-Prod aveva una sola, cruciale differenza rispetto allo Staging: la variabile d'ambiente <code>USE_MOCK_AI_PROVIDER</code> era impostata su <code>False</code>. Ogni chiamata all'AI sarebbe stata una chiamata reale, con costi reali e risposte reali.</p>

<h3>Il Test: Stressare l'Intelligenza, non solo il Codice</h3>

<p>L'obiettivo di questo test non era trovare bug nel nostro codice (quelli avrebbero dovuto essere gi√† stati scoperti), ma validare il <strong>comportamento emergente</strong> del sistema quando interagiva con una vera intelligenza artificiale.</p>

<p><em>Codice di riferimento: <code>tests/test_production_complete_e2e.py</code></em>
<em>Evidenza dai Log: <code>production_e2e_test.log</code></em></p>

<p>Abbiamo eseguito lo stesso scenario del test comprensivo, ma questa volta con l'AI reale. Stavamo cercando risposte a domande che solo un test del genere poteva dare:</p>

<ol>
<li><strong>Qualit√† del Ragionamento:</strong> L'AI, senza i binari di un mock, √® in grado di scomporre un obiettivo complesso in modo logico?</li>
<li><strong>Robustezza del Parsing:</strong> Il nostro <code>IntelligentJsonParser</code> √® in grado di gestire le stranezze e le idiosincrasie di un vero output di GPT-4?</li>
<li><strong>Efficienza dei Costi:</strong> Quanto costa, in termini di token e chiamate API, completare un intero progetto? Il nostro sistema √® economicamente sostenibile?</li>
<li><strong>Latenza e Performance:</strong> Come si comporta il sistema con le latenze reali delle API? I nostri timeout sono configurati correttamente?</li>
</ol>

<h3>"War Story": La Scoperta del "Bias di Dominio" dell'AI</h3>

<p>Il test di produzione ha funzionato. Ma ha rivelato un problema incredibilmente sottile che non avremmo mai scoperto con un mock.</p>

<p><em>Logbook del Disastro (Analisi post-test di produzione):</em></p>

<pre><code class="language-text">ANALISI: Il sistema ha completato il progetto B2B SaaS con successo.
Tuttavia, quando √® stato testato con l&#x27;obiettivo &quot;Crea un programma di allenamento per bodybuilding&quot;,
i task generati erano pieni di gergo di marketing (&quot;KPI del workout&quot;, &quot;ROI muscolare&quot;).</code></pre>

<p><strong>Il Problema:</strong> Il nostro <code>Director</code> e l'<code>AnalystAgent</code>, pur essendo stati istruiti a essere universali, avevano sviluppato un <strong>"bias di dominio"</strong>. Poich√© la maggior parte dei nostri test e degli esempi nei prompt erano legati al mondo del business e del marketing, l'AI aveva "imparato" che quello era il modo "corretto" di pensare, e applicava lo stesso schema a domini completamente diversi.</p>

<p><strong>La Lezione Appresa: L'Universalit√† Richiede una "Pulizia del Contesto".</strong></p>

<p>Per essere veramente agnostico al dominio, non basta dirlo all'AI. Bisogna assicurarsi che il contesto fornito sia il pi√π neutro possibile.</p>

<p>La soluzione √® stata un'evoluzione del nostro <strong>Pilastro #15 (Conversazione Context-Aware)</strong>, applicato non solo alla chat, ma a ogni interazione con l'AI:</p>

<ol>
<li><strong>Contesto Dinamico:</strong> Inceve di avere un unico, enorme <code>system_prompt</code>, abbiamo iniziato a costruire il contesto dinamicamente per ogni chiamata.</li>
<li><strong>Estrazione del Dominio:</strong> Prima di chiamare il <code>Director</code> o l'<code>AnalystAgent</code>, un piccolo agente preliminare analizza il goal del workspace per estrarre il dominio di business (es. "Fitness", "Finanza", "SaaS").</li>
<li><strong>Prompt Contestualizzato:</strong> Questa informazione sul dominio viene usata per adattare il prompt. Se il dominio √® "Fitness", aggiungiamo una frase come: <em>"Stai lavorando nel settore del fitness. Usa un linguaggio e delle metriche appropriate per questo dominio (es. 'ripetizioni', 'massa muscolare'), non termini di business come 'KPI' o 'ROI'."</em></li>
</ol>

<p>Questo ha risolto il problema del "bias" e ha permesso al nostro sistema di adattare non solo le sue azioni, ma anche il suo <strong>linguaggio e il suo stile di pensiero</strong> al dominio specifico di ogni progetto.</p>

<div class="key-takeaways-section">
    <h4 class="key-takeaways-title">üìù Key Takeaways del Capitolo:</h4>
    <div class="key-takeaways-content"><p class="takeaway-item">‚úì <strong>Crea un Ambiente di Pre-Produzione:</strong> √à l'unico modo per testare in modo sicuro le interazioni del tuo sistema con servizi esterni reali.</p>
<p class="takeaway-item">‚úì <strong>Testa il Comportamento Emergente:</strong> I test di produzione non servono a trovare bug nel codice, ma a scoprire i comportamenti inaspettati che emergono dall'interazione con un sistema complesso e non deterministico come un LLM.</p>
<p class="takeaway-item">‚úì <strong>Fai Attenzione al "Bias di Contesto":</strong> L'AI impara dagli esempi che le fornisci. Assicurati che i tuoi prompt e i tuoi esempi siano il pi√π possibile neutri e agnostici al dominio, o, ancora meglio, adatta il contesto dinamicamente.</p>
<p class="takeaway-item">‚úì <strong>Misura i Costi:</strong> I test di produzione sono anche test di sostenibilit√† economica. Traccia il consumo di token per assicurarti che il tuo sistema sia economicamente vantaggioso.</p>
    </div>
</div>

<p><strong>Conclusione del Capitolo</strong></p>

<p>Con il successo del test di produzione, avevamo raggiunto un traguardo fondamentale. Il nostro sistema non era pi√π un prototipo o un esperimento. Era un'applicazione robusta, testata e pronta per affrontare il mondo reale.</p>

<p>Avevamo costruito la nostra orchestra AI. Ora era il momento di aprire le porte del teatro e di farla suonare per il suo pubblico: l'utente finale. La nostra attenzione si √® quindi spostata sull'interfaccia, sulla trasparenza e sull'esperienza utente.</p>
            </div>

            
        </article>

        <!-- Bottom Navigation -->
        <nav class="chapter-nav-bottom">
            <a href="../test-comprensivo-esame-maturita/" class="nav-button secondary">‚Üê Capitolo Precedente</a>
            <a href="../../user-experience-trasparenza/chat-contestuale-dialogare-team-ai/" class="nav-button">Prossimo Capitolo ‚Üí</a>
        </nav>
    </div>

    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#667eea',
                lineColor: '#7f8c8d',
                secondaryColor: '#f8f9fa',
                tertiaryColor: '#ffffff'
            }
        });
    </script>

    <!-- Prism.js for code highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VEGK4VZMG0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-VEGK4VZMG0');
        
        gtag('event', 'chapter_start', {
            'chapter_title': 'Il Test di Produzione ‚Äì Sopravvivere nel Mondo Reale',
            'movement': 'esecuzione-qualita',
            'chapter_number': 19
        });
    </script>
    <script src="../../shared-reader-tools.js"></script>
</body>
    
    <script>
        // Reading Progress
        function updateReadingProgress() {
            const article = document.querySelector('.chapter-content');
            const progress = document.getElementById('readingProgress');
            
            if (article && progress) {
                const articleTop = article.offsetTop;
                const articleHeight = article.offsetHeight;
                const windowTop = window.pageYOffset;
                const windowHeight = window.innerHeight;
                
                const articleBottom = articleTop + articleHeight;
                const windowBottom = windowTop + windowHeight;
                
                let progressPercentage = 0;
                
                if (windowTop >= articleTop && windowTop <= articleBottom) {
                    progressPercentage = ((windowTop - articleTop) / articleHeight) * 100;
                } else if (windowBottom >= articleBottom) {
                    progressPercentage = 100;
                }
                
                progress.style.transform = `scaleX(${Math.min(progressPercentage / 100, 1)})`;
            }
        }
        
        window.addEventListener('scroll', updateReadingProgress);
        window.addEventListener('load', updateReadingProgress);
        
        // Font Size Controls
        let currentFontSize = 1.1;
        
        function increaseFontSize() {
            currentFontSize = Math.min(currentFontSize + 0.1, 2.0);
            applyFontSize();
        }
        
        function decreaseFontSize() {
            currentFontSize = Math.max(currentFontSize - 0.1, 0.8);
            applyFontSize();
        }
        
        function applyFontSize() {
            const content = document.querySelector('.chapter-content');
            if (content) {
                const paragraphs = content.querySelectorAll('p, li');
                paragraphs.forEach(p => {
                    p.style.fontSize = currentFontSize + 'rem';
                });
            }
            localStorage.setItem('fontSize', currentFontSize.toString());
        }
        
        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark.toString());
            showToast(isDark ? 'Modalit√† scura attivata' : 'Modalit√† chiara attivata');
        }
        
        // Bookmarks
        function toggleBookmarks() {
            const modal = document.getElementById('bookmarksModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
            loadBookmarks();
        }
        
        function closeBookmarksModal() {
            document.getElementById('bookmarksModal').style.display = 'none';
        }
        
        function addBookmark() {
            const title = document.querySelector('.chapter-title').textContent;
            const url = window.location.href;
            
            let bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            
            // Check if bookmark already exists
            const exists = bookmarks.find(b => b.url === url);
            if (exists) {
                showToast('Segnalibro rimosso!');
                bookmarks = bookmarks.filter(b => b.url !== url);
            } else {
                showToast('Segnalibro salvato!');
                bookmarks.push({
                    title: title,
                    url: url,
                    timestamp: new Date().toISOString()
                });
            }
            
            localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
        }
        
        function loadBookmarks() {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks') || '[]');
            const container = document.getElementById('bookmarksList');
            
            if (bookmarks.length === 0) {
                container.innerHTML = '<p>Nessun segnalibro salvato.</p>';
                return;
            }
            
            container.innerHTML = bookmarks
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(bookmark => `
                    <div class="bookmark-item">
                        <a href="${bookmark.url}" class="bookmark-link">${bookmark.title}</a>
                    </div>
                `).join('');
        }
        
        // Toast Notifications
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 2000);
        }
        
        // Load saved preferences
        window.addEventListener('load', function() {
            // Load font size
            const savedFontSize = localStorage.getItem('fontSize');
            if (savedFontSize) {
                currentFontSize = parseFloat(savedFontSize);
                applyFontSize();
            }
            
            // Load theme
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
            }
        });
    </script>
</html>